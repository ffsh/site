name: Create new release

on:
  release:
      types: [published]

jobs:
  download_and_release:
    name: "Create release archive"
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ffsh/firmware-collector
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
      - name: Install python deps
        run: pip3 install -r requirements.txt
      - name: Initalize the internal DB
        run: python3 ./automation.py --update
        env:
          ffsh_url: ${{ secrets.ffsh_url }}
          ffsh_username: ${{ secrets.ffsh_username }}
          ffsh_secret: ${{ secrets.ffsh_secret }}
      - name: Download the Artifacts
        run: python3 ./automation.py --download ${{ steps.get_version.outputs.VERSION }}
        env:
          ffsh_url: ${{ secrets.ffsh_url }}
          ffsh_username: ${{ secrets.ffsh_username }}
          ffsh_secret: ${{ secrets.ffsh_secret }}
      - name: Unpack the Artifacts
        run: python3 ./automation.py --store
        env:
          ffsh_url: ${{ secrets.ffsh_url }}
          ffsh_username: ${{ secrets.ffsh_username }}
          ffsh_secret: ${{ secrets.ffsh_secret }}
      - name: Generate Manifests
        run: |
          python3 ./automation.py --manifest ${{ steps.get_version.outputs.VERSION }} --branch testing
          python3 ./automation.py --manifest ${{ steps.get_version.outputs.VERSION }} --branch rc
        env:
          ffsh_url: ${{ secrets.ffsh_url }}
          ffsh_username: ${{ secrets.ffsh_username }}
          ffsh_secret: ${{ secrets.ffsh_secret }}
      - name: sign manifests
        run: |
          sudo apt-get -y update
          sudo apt-get -y install ecdsautils
          python3 ./create_secret.py ffsh_key /tmp/secret_key
          ./sign.sh /tmp/secret_key /tmp/ffsh/firmware_store/${{ steps.get_version.outputs.VERSION }}/sysupgrade/stable.manifest
          ./sign.sh /tmp/secret_key /tmp/ffsh/firmware_store/${{ steps.get_version.outputs.VERSION }}/sysupgrade/testing.manifest
          ./sign.sh /tmp/secret_key /tmp/ffsh/firmware_store/${{ steps.get_version.outputs.VERSION }}/sysupgrade/rc.manifest
          echo "0000000000000000000000000000000000000000000000000000000000000" > /tmp/secret_key
        env:
          ffsh_key: ${{ secrets.ffsh_key }}
      - name: create release archive
        run: |
          cd /tmp/ffsh/firmware_store/
          tar cfz ${{ steps.get_version.outputs.VERSION }}.tar.gz ${{ steps.get_version.outputs.VERSION }}
      - name: Upload release archive to release
        uses: svenstaro/upload-release-action@7319e4733ec7a184d739a6f412c40ffc339b69c7
        id: attach_to_release
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: /tmp/ffsh/firmware_store/${{ steps.get_version.outputs.VERSION }}.tar.gz
          asset_name: ${{ steps.get_version.outputs.VERSION }}.tar.gz
          tag: ${{ steps.get_version.outputs.VERSION }}
          overwrite: true
